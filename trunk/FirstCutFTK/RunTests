#!/usr/bin/env ruby
#
# $Id$
#
# Generates a Fortran 90 code which runs all the mobility
# test suites in this directory (or only those test suites
# specified on the command line).

# check for a Fortran Compiler:
unless ENV['F9X']
 puts "\nFortran 9X compiler environment variable F9X not set"
 puts "for bourne-based shells (sh, bash):  export F9X=lf95"
 puts "     for c-based shells (csh, tcsh): setenv F9X lf95"
 exit 1
end

# find all the tests in the current directory:

testSuites = Dir["*Test.ftk"]
testSuites.each { |testSuite| testSuite.chomp! "Test.ftk" }

# optionally, handle tests given as command line arguments:

unless $*.empty?
 testSuitesNotFound = $* - ( $* & testSuites )
 unless testSuitesNotFound.empty?
  print "\n"
  print " Error: could not find test suite:"
  testSuitesNotFound.each {|testSuiteNotFound| print " #{testSuiteNotFound}"}
  print "\n\n"
  print " Test suites available in this directory:\n"
  testSuites.each { |testSuite| print "  #{testSuite}\n" }
  print "\nUsage: #{File.basename $0} [test names (w/o Test.ftk suffix)]\n\n"
  exit 1
 else
  testSuites = $*
 end
end


# create the Fortran9X program which calls all the test suites:

testRunner = File.new "TestRunner.f90", "w"

testRunner.puts <<HEADER
! TestRunner.f90 - runs Fortran mobility test suites
!
! [Note: dynamically generated by #{File.basename $0} Ruby script #{Time.now}.]

program TestRunner

HEADER

testSuites.each { |testSuite| testRunner.puts " use #{testSuite}TestSuite" }

testSuites.each do |testSuite|
 testRunner.puts "\n print *, \"\""
 testRunner.puts " print *, \"#{testSuite} Test Suite (#{testSuite}Test.ftk):\""
 testRunner.puts " call Test#{testSuite}"
end

testRunner.puts "\n print *, \"\""
testRunner.puts "\nend program TestRunner"
testRunner.close


# convert each *Test.ftk file into pure Fortran9x:

testSuites.each do |testSuite|

 testSuiteCode = File.new(testSuite+"Test.f90","w")

 testSuiteCode.puts <<TOP
! #{testSuite}Test.f90
!
! [Note: dynamically generated from #{testSuite}Test.ftk
!        by #{File.basename $0} Ruby script #{Time.now}
!        

TOP

 testSuiteCode.puts "module #{testSuite}TestSuite\n\n"
 testSuiteCode.puts " use #{testSuite}\n\n"

 inTest     = false
 inSetup    = false
 inTeardown = false
 noMacros   = true

 setupCode     = []
 teardownCode  = []
 callTestsCode = []

 testName   = ""
 lineNumber = 0

 IO.foreach(testSuite+"Test.ftk") do |line|
  if line=~/begin(Setup|Teardown|Test)/ && noMacros
   testSuiteCode.puts "  logical :: noAssertFailed\n\n"
   testSuiteCode.puts " public"
   testSuiteCode.puts " contains\n\n"
   noMacros = false
  end
  lineNumber += 1
  case line
   when /^\s*!/
    testSuiteCode.puts line
   when /beginSetup/
    inSetup = true
   when /endSetup/
    inSetup = false
   when /beginTearDown/
    inTeardown = true
   when /endTeardown/
    inTeardown = false
   when /beginTest \s*(.*)/
    inTest = true
    testName = $1
    testSuiteCode.puts " subroutine test#{testName}"
    callTestsCode.push "\n  print *,\" Testing #{testName}\""
    callTestsCode.push "  call Setup"
    callTestsCode.push "  call test#{testName}"
    callTestsCode.push "  call Teardown\n"
   when /endTest/
    inTest = false
    testSuiteCode.puts " end subroutine test#{testName}"
   when /(IsFloatEqual)\s*\((.*),(.*),(.*)\)/
    print "Error: assertion outside of a test block" if !inTest
    testSuiteCode.puts "  ! #$1 assertion"
    testSuiteCode.puts "  if (noAssertFailed) then"
    testSuiteCode.puts "   if (.not.(#$3+#$4.ge.#$2.and.#$3-#$4.le.#$2))then"
    testSuiteCode.puts "    print *, \"  FAILURE! #$1: Line #{lineNumber}\""
    testSuiteCode.puts "    print *, \"   #$2 (\",#$2,\") is not #$3 within #$4\""
    testSuiteCode.puts "    noAssertFailed = .false."
    testSuiteCode.puts "   endif"
    testSuiteCode.puts "  endif"
   when /(IsEqual)\s*\((.*),(.*)\)/
    print "Error: assertion outside of a test block" if !inTest
    testSuiteCode.puts "  ! #$1 assertion"
    testSuiteCode.puts "  if (noAssertFailed) then"
    testSuiteCode.puts "   if (.not.(#$2==#$3)) then"
    testSuiteCode.puts "    print *, \"  FAILURE! #$1: Line #{lineNumber}\""
    testSuiteCode.puts "    print *, \"   #$2 (\", #$2, \") is not #$3\""
    testSuiteCode.puts "    noAssertFailed = .false."
    testSuiteCode.puts "   endif"
    testSuiteCode.puts "  endif"
   when /(IsTrue)\s*\((.*)\)/
    print "Error: assertion outside of a test block" if !inTest
    testSuiteCode.puts "  ! #$1 assertion"
    testSuiteCode.puts "  if (noAssertFailed) then"
    testSuiteCode.puts "   if (.not.(#$2)) then"
    testSuiteCode.puts "    print *, \"  FAILURE! #$1: Line #{lineNumber}\""
    testSuiteCode.puts "    print *, \"   #$2 (\", #$2, \") is not true\""
    testSuiteCode.puts "    noAssertFailed = .false."
    testSuiteCode.puts "   endif"
    testSuiteCode.puts "  endif"
   when /(IsFalse)\s*\((.*)\)/
    print "Error: assertion outside of a test block" if !inTest
    testSuiteCode.puts "  ! #$1 assertion"
    testSuiteCode.puts "  if (noAssertFailed) then"
    testSuiteCode.puts "   if (#$2) then"
    testSuiteCode.puts "    print *, \"  FAILURE! #$1: Line #{lineNumber}\""
    testSuiteCode.puts "    print *, \"   #$2 (\", #$2, \") is not false\""
    testSuiteCode.puts "    noAssertFailed = .false."
    testSuiteCode.puts "   endif"
    testSuiteCode.puts "  endif"
   else
    if inSetup
     setupCode.push line
    elsif inTeardown
     teardownCode.push line
    else
     testSuiteCode.puts line
    end
  end
 end

 testSuiteCode.puts "\n subroutine Setup"
 testSuiteCode.puts "  noAssertFailed = .true."
 setupCode.each    { |line| testSuiteCode.puts line }
 testSuiteCode.puts " end subroutine Setup\n\n"

 testSuiteCode.puts " subroutine Teardown"
 teardownCode.each { |line| testSuiteCode.puts line }
 testSuiteCode.puts " end subroutine Teardown\n\n"

 testSuiteCode.puts " subroutine Test#{testSuite}"
 callTestsCode.each { |line| testSuiteCode.puts line }
 testSuiteCode.puts "\n end subroutine Test#{testSuite}\n\n"

 testSuiteCode.puts "end module #{testSuite}TestSuite"
 testSuiteCode.close

end


# Compile, link, and run:

sources = testSuites.join(".f90 ") + ".f90"
tests   = testSuites.join("Test.f90 ") + "Test.f90"

system "TestRunner" \
  if (system "#{ENV['F9X']} -o TestRunner #{sources} #{tests} TestRunner.f90")
