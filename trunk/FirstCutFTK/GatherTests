#!/usr/bin/env ruby
#
# $Id$
#
# Generates a Fortran 90 code which runs all the mobility tests
# in this directory (or only those tests specified on the command
# line).

def printUsage
 puts <<-USAGE

 Usage: #{File.basename $0} [test names (w/o Test.F90 suffix)]

USAGE
end

if ARGV[0]
 tests = ARGV
else
 tests = Dir["*Test.F90"]
 tests.each { |f| f.chomp! "Test.F90" }
end

testsNotFound = []

tests.each do |test|
 testsNotFound.push(test) unless FileTest.exists?(test+"Test.F90")
end

if (!testsNotFound.empty?)
 print "\n"
 print " Error: could not find test"
 print "s" unless testsNotFound.size == 1
 print ":"
 testsNotFound.each {|test| print " #{test}"}
 print "\n\n"
 print " Tests available in this directory:\n"
 Dir["*Test.F90"].each { |f| print "  #{f.chomp('Test.F90')}\n" }
 printUsage
 File.delete "TestRunner.f90" if FileTest.exists? "TestRunner.f90"
 exit 1
end

testRunner = File.new "TestRunner.f90", "w"

testRunner.puts <<-HEADER
! TestRunner.f90 - runs Fortran mobility tests
!                  [generated by #{File.basename $0} Ruby script]
program TestRunner

 use FTK

 implicit none

 continue

HEADER

tests.each do |testName|
 testRunner.puts " print *, \"\""
 testRunner.puts " print *, \"#{testName}Test:\""
 testRunner.puts " call Test#{testName}"
 testRunner.puts ""
end

testRunner.puts <<-TAILER
end program TestRunner
TAILER
